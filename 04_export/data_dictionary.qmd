---
title: "1CHO Data dictionary na pipeline"
subtitle: "Variabelen overzicht - Automatisch gegenereerd"
format:
  html:
    toc: true
    toc-depth: 2
    self-contained: true
    theme: cosmo
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
# Load required packages for data dictionary
library(config)
library(fst)
library(dplyr)
library(purrr)
library(stringr)
library(tibble)
library(reactable)
library(htmltools)
library(base64enc)

# Get institution name for display
institution_name <- config::get("metadata_institution_name")
```

```{r load-data}
# Load final output data (try rds format first, then fst)
# Paths relative to project root (04_export/ is one level down)
data_path_rds <- "../data/03_combined/enrollments.rds"
data_path_fst <- "../data/03_combined/prepared_enrollments.fst"

if (file.exists(data_path_rds)) {
  df <- readRDS(data_path_rds)
} else if (file.exists(data_path_fst)) {
  df <- fst::read_fst(data_path_fst)
} else {
  stop("No data file found in data/03_combined/")
}

# Load source metadata (contains original variables from 1CHO)
source_metadata <- read.csv2(
  "../metadata/assertions/Documentatie_enrollments.csv"
)
original_vars <- source_metadata$Veldnaam
```

```{r compute-statistics}
# Compute detailed statistics for each column
stats <- map_dfr(names(df), function(col) {
  x <- df[[col]]

  # Basic stats
  n_total <- length(x)
  n_na <- sum(is.na(x))
  na_pct <- round(n_na / n_total * 100, 1)
  n_uniek <- n_distinct(x, na.rm = TRUE)

  # Type detection
  col_type <- if (is.numeric(x)) {
    "numeric"
  } else if (is.logical(x)) {
    "logical"
  } else if (is.factor(x)) {
    "factor"
  } else {
    "character"
  }

  # Non-NA values for calculations

  non_na_vals <- na.omit(x)

  # Numeric statistics (min/max)
  if (col_type == "numeric" && length(non_na_vals) > 0) {
    min_val <- min(non_na_vals, na.rm = TRUE)
    max_val <- max(non_na_vals, na.rm = TRUE)
    stats_summary <- paste0(
      "Min: ",
      format(round(min_val, 1), big.mark = "."),
      " | Max: ",
      format(round(max_val, 1), big.mark = ".")
    )
  } else {
    stats_summary <- NA_character_
  }

  # Top 3 most common values with percentage (for all types)
  if (length(non_na_vals) > 0) {
    top_vals_all <- sort(table(non_na_vals), decreasing = TRUE)
    top_3 <- head(top_vals_all, 3)
    total_non_na <- length(non_na_vals)
    veel_voorkomend <- paste(
      paste0(
        substr(as.character(names(top_3)), 1, 12),
        " (",
        round(as.numeric(top_3) / total_non_na * 100),
        "%)"
      ),
      collapse = ", "
    )
  } else {
    veel_voorkomend <- NA_character_
  }

  tibble(
    Veldnaam = col,
    Prefix = str_extract(col, "^[A-Z]+"),
    Type = col_type,
    NA_pct = na_pct,
    N_uniek = n_uniek,
    Herkomst = if_else(col %in% original_vars, "Bron", "Toegevoegd"),
    Stats = stats_summary,
    Veel_voorkomend = veel_voorkomend
  )
})

# Add descriptions from source metadata where available
stats <- stats |>
  left_join(
    source_metadata |>
      select(Veldnaam, Veldnaam_export) |>
      distinct(),
    by = "Veldnaam"
  )
```

## Overzicht

Dit document bevat een overzicht van alle **`r nrow(stats)`** variabelen in de 1CHO dataset voor **`r institution_name`**.

::: {.callout-note appearance="simple"}
**Verdeling:** INS_ (`r sum(stats$Prefix == "INS", na.rm = TRUE)`) | OPL_ (`r sum(stats$Prefix == "OPL", na.rm = TRUE)`) | DEM_ (`r sum(stats$Prefix == "DEM", na.rm = TRUE)`) | SUC_ (`r sum(stats$Prefix == "SUC", na.rm = TRUE)`) | Overig (`r sum(!stats$Prefix %in% c("INS", "OPL", "DEM", "SUC"), na.rm = TRUE)`)

**Herkomst:** Bron (1CHO): `r sum(stats$Herkomst == "Bron")` | Toegevoegd (pipeline): `r sum(stats$Herkomst == "Toegevoegd")`

**Observaties:** `r format(nrow(df), big.mark = ".")` | **Gegenereerd:** `r format(Sys.time(), "%Y-%m-%d %H:%M")`
:::

---

## Variabelen

```{r variabelen-tabel}
#| column: page

# Helper function for dropdown filter
dropdown_filter <- function(values, name) {
  unique_vals <- sort(unique(values))
  tags$select(
    onchange = sprintf(
      "Reactable.setFilter('stats-table', '%s', event.target.value || undefined)",
      name
    ),
    style = "width: 100%; height: 28px;",
    tags$option(value = "", "Alle"),
    lapply(unique_vals, function(v) tags$option(value = v, v))
  )
}

# Function to create mini histogram as base64 image (simple, no axis)
create_mini_plot <- function(col_name, width = 80, height = 25) {
  x <- df[[col_name]]
  col_type <- stats$Type[stats$Veldnaam == col_name]

  if (all(is.na(x))) {
    return("")
  }

  # Create temp file for the plot
  tmp <- tempfile(fileext = ".png")

  if (col_type == "numeric") {
    # Numeric: histogram
    png(tmp, width = width, height = height, bg = "transparent")
    par(mar = c(0, 0, 0, 0))
    hist(
      x,
      breaks = 15,
      col = "#3498db",
      border = NA,
      main = "",
      xlab = "",
      ylab = "",
      axes = FALSE
    )
    dev.off()
  } else {
    # Categorical: bar chart of top 5
    non_na <- na.omit(x)
    if (length(non_na) == 0) {
      return("")
    }
    top_vals <- head(sort(table(non_na), decreasing = TRUE), 5)
    png(tmp, width = width, height = height, bg = "transparent")
    par(mar = c(0, 0, 0, 0))
    barplot(top_vals, col = "#9b59b6", border = NA, axes = FALSE)
    dev.off()
  }

  # Read and encode as base64
  img_data <- base64enc::base64encode(tmp)
  unlink(tmp)
  paste0(
    '<img src="data:image/png;base64,',
    img_data,
    '" style="vertical-align: middle;">'
  )
}

# Pre-generate all mini plots
stats$MiniPlot <- sapply(stats$Veldnaam, create_mini_plot)

# Main table - uses column: page for full width
reactable(
  stats |>
    select(
      Veldnaam,
      Prefix,
      Type,
      NA_pct,
      N_uniek,
      Stats,
      Veel_voorkomend,
      Herkomst,
      MiniPlot
    ),
  elementId = "stats-table",
  filterable = TRUE,
  searchable = TRUE,
  defaultPageSize = 30,
  showPageSizeOptions = TRUE,
  pageSizeOptions = c(15, 30, 50, 100),
  striped = TRUE,
  highlight = TRUE,
  bordered = TRUE,
  defaultColDef = colDef(vAlign = "center"),

  columns = list(
    Veldnaam = colDef(
      name = "Veldnaam",
      minWidth = 280,
      sticky = "left",
      style = list(
        fontFamily = "monospace",
        fontWeight = "500",
        fontSize = "13px"
      )
    ),

    Prefix = colDef(
      name = "Prefix",
      width = 70,
      filterInput = dropdown_filter,
      style = function(value) {
        colors <- c(
          "INS" = "#3498db",
          "OPL" = "#9b59b6",
          "DEM" = "#e67e22",
          "SUC" = "#27ae60"
        )
        list(
          color = colors[value] %||% "#7f8c8d",
          fontWeight = "bold"
        )
      }
    ),

    Type = colDef(
      name = "Type",
      width = 85,
      filterInput = dropdown_filter
    ),

    NA_pct = colDef(
      name = "NA %",
      width = 70,
      format = colFormat(suffix = "%"),
      style = function(value) {
        color <- if (value > 50) {
          "#e74c3c"
        } else if (value > 20) {
          "#f39c12"
        } else {
          "#27ae60"
        }
        list(color = color, fontWeight = "bold")
      }
    ),

    N_uniek = colDef(
      name = "Uniek",
      width = 80,
      format = colFormat(separators = TRUE)
    ),

    Stats = colDef(
      name = "Min / Max",
      minWidth = 150,
      style = list(fontSize = "12px", color = "#555")
    ),

    Veel_voorkomend = colDef(
      name = "Veel voorkomend",
      minWidth = 200,
      style = list(fontSize = "12px", color = "#555")
    ),

    Herkomst = colDef(
      name = "Herkomst",
      width = 100,
      filterInput = dropdown_filter,
      style = function(value) {
        bg <- if (value == "Toegevoegd") "#e8f4fd" else "#fff"
        list(background = bg)
      }
    ),

    MiniPlot = colDef(
      name = "Distributie",
      width = 100,
      html = TRUE,
      sortable = FALSE,
      filterable = FALSE
    )
  ),

  theme = reactableTheme(
    headerStyle = list(
      background = "#f7f7f8",
      borderBottom = "2px solid #e1e1e1",
      fontSize = "12px"
    ),
    cellStyle = list(
      fontSize = "13px"
    )
  )
)
```
